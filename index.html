<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>rstatus.rb</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Rakefile.html">Rakefile</a>
          <a class="source" href="models/all.html">all.rb</a>
          <a class="source" href="models/author.html">author.rb</a>
          <a class="source" href="models/authorization.html">authorization.rb</a>
          <a class="source" href="models/feed.html">feed.rb</a>
          <a class="source" href="models/notifier.html">notifier.rb</a>
          <a class="source" href="models/update.html">update.rb</a>
          <a class="source" href="models/user.html">user.rb</a>
          <a class="source" href="rstatus.html">rstatus.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>rstatus.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">require</span>

<span class="k">module</span> <span class="nn">Sinatra</span>
  <span class="k">module</span> <span class="nn">UserHelper</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>This incredibly useful helper gives us the currently logged in user. We
keep track of that by just setting a session variable with their id. If it
doesn&rsquo;t exist, we just want to return nil.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">current_user</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>This very simple method checks if we&rsquo;ve got a logged in user. That&rsquo;s pretty
easy: just check our current_user.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">logged_in?</span>
      <span class="n">current_user</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Our <code>admin_only!</code> helper will only let admin users visit the page. If
they&rsquo;re not an admin, we redirect them to either / or the page that we
specified when we called it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">admin_only!</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:return</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">})</span>
      <span class="k">unless</span> <span class="n">logged_in?</span> <span class="o">&amp;&amp;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Sorry, buddy&quot;</span>
        <span class="n">redirect</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:return</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Similar to <code>admin_only!</code>, <code>require_login!</code> only lets logged in users access
a particular page, and redirects them if they&rsquo;re not.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">require_login!</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:return</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">})</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Sorry, buddy&quot;</span>
        <span class="n">redirect</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:return</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_params_page</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">1</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">25</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">].</span><span class="n">to_i</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">].</span><span class="n">to_i</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_next_prev_page</span>
      <span class="vi">@next_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>

      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="vi">@prev_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">else</span>
        <span class="vi">@prev_page</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">helpers</span> <span class="no">UserHelper</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Rstatus</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">set</span> <span class="ss">:port</span><span class="p">,</span> <span class="mi">8088</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>The <code>PONY_VIA_OPTIONS</code> hash is used to configure <code>pony</code>. Basically, we only
want to actually send mail if we&rsquo;re in the production environment. So we set
the hash to just be <code>{}</code>, except when we want to send mail.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">configure</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">end</span>

  <span class="n">configure</span> <span class="ss">:development</span> <span class="k">do</span>
    <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">end</span>

  <span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
    <span class="nb">require</span> <span class="s1">&#39;newrelic_rpm&#39;</span>
    <span class="no">Compass</span><span class="o">.</span><span class="n">configuration</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
      <span class="n">config</span><span class="o">.</span><span class="n">output_style</span> <span class="o">=</span> <span class="ss">:compressed</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>We&rsquo;re using <a href="http://sendgrid.com/">SendGrid</a> to send our emails. It&rsquo;s really
easy; the Heroku addon sets us up with environment variables with all of the
configuration options that we need.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
    <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span>  <span class="p">{</span>
      <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s2">&quot;smtp.sendgrid.net&quot;</span><span class="p">,</span>
      <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
      <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
      <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_USERNAME&#39;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_PASSWORD&#39;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_DOMAIN&#39;</span><span class="o">]</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Cookie</span><span class="p">,</span> <span class="ss">:secret</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COOKIE_SECRET&#39;</span><span class="o">]</span>
  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Timeout</span>
  <span class="no">Rack</span><span class="o">::</span><span class="no">Timeout</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># this line is optional. if omitted, default is 30 seconds.</span>

  <span class="n">set</span> <span class="ss">:root</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
  <span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:escape_html</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">set</span> <span class="ss">:method_override</span><span class="p">,</span> <span class="kp">true</span>

  <span class="nb">require</span> <span class="s1">&#39;rack-flash&#39;</span>
  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Flash</span>

  <span class="n">configure</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_URL&#39;</span><span class="o">]</span>
      <span class="no">MongoMapper</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_URL&#39;</span><span class="o">]</span><span class="p">}}</span>
      <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_DATABASE&#39;</span><span class="o">]</span>
      <span class="no">MongoMapper</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;production&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">MongoMapper</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
      <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;rstatus-</span><span class="si">#{</span><span class="n">settings</span><span class="o">.</span><span class="n">environment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>configure compass</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="no">Compass</span><span class="o">.</span><span class="n">configuration</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
      <span class="n">config</span><span class="o">.</span><span class="n">project_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
      <span class="n">config</span><span class="o">.</span><span class="n">sass_options</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:cache_location</span> <span class="o">=&gt;</span> <span class="s2">&quot;./tmp/sass-cache&quot;</span><span class="p">}</span>
    <span class="k">end</span>
    <span class="no">MongoMapperExt</span><span class="o">.</span><span class="n">init</span>
    <span class="n">require_relative</span> <span class="s1">&#39;models/all&#39;</span>
  <span class="k">end</span>

  <span class="n">helpers</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">UserHelper</span>
  <span class="n">helpers</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">ContentFor</span>

  <span class="n">helpers</span> <span class="k">do</span>
    <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:test</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">environment</span><span class="o">|</span>
      <span class="n">define_method</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">environment</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">?&quot;</span> <span class="k">do</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="n">environment</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
    <span class="n">provider</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_KEY&quot;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_SECRET&quot;</span><span class="o">]</span>
    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;APP_ID&quot;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;APP_SECRET&quot;</span><span class="o">]</span><span class="p">,</span> <span class="p">{</span><span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="s1">&#39;publish_stream,offline_access,email&#39;</span><span class="p">}</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-#'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-#">&#182;</a>
        </div>
        <h6>#</h6>

<p>EMPTY USERNAME HANDLING &ndash; quick and dirty</p>

<h6>#</h6>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@error_bar</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">current_user</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">nil?</span> <span class="ow">or</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">or</span> <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/profile.php/</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>
      <span class="vi">@error_bar</span> <span class="o">=</span> <span class="n">haml</span> <span class="ss">:_username_error</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/reset-username&#39;</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">end</span>

    <span class="n">haml</span> <span class="ss">:reset_username</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s1">&#39;/reset-username&#39;</span> <span class="k">do</span>
    <span class="n">exists</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">].</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">].</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">exists</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">reset_username</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Thank you for updating your username&quot;</span>
      <span class="k">else</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Your username could not be updated&quot;</span>
      <span class="k">end</span>
      <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Sorry, that username has already been taken or is not valid. Please try again.&quot;</span>
      <span class="n">haml</span> <span class="ss">:reset_username</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-#'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-#">&#182;</a>
        </div>
        <h6>#</h6>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="n">set_params_page</span>
      <span class="vi">@updates</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">timeline</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">set_next_prev_page</span> <span class="k">if</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">total_entries</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span>

      <span class="vi">@timeline</span> <span class="o">=</span> <span class="kp">true</span>

      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:reply</span><span class="o">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:reply</span><span class="o">]</span><span class="p">)</span>
        <span class="vi">@update_text</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="vi">@update_id</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span>
      <span class="k">elsif</span> <span class="n">params</span><span class="o">[</span><span class="ss">:share</span><span class="o">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:share</span><span class="o">]</span><span class="p">)</span>
        <span class="vi">@update_text</span> <span class="o">=</span> <span class="s2">&quot;RS @</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="vi">@update_id</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span>
      <span class="k">else</span>
        <span class="vi">@update_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="vi">@update_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
        <span class="vi">@update_text</span> <span class="o">=</span> <span class="vi">@update_text</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">haml</span> <span class="ss">:dashboard</span>
    <span class="k">else</span>
      <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/home&#39;</span> <span class="k">do</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
    <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>get &lsquo;/screen.css&rsquo; do
  cache_control :public, :must_revalidate, :max_age => 360
  scss(:screen, Compass.sass_engine_options)
end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s1">&#39;/replies&#39;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="n">set_params_page</span>
      <span class="vi">@replies</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">at_replies</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">set_next_prev_page</span> <span class="k">if</span> <span class="vi">@replies</span><span class="o">.</span><span class="n">total_entries</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span>
      <span class="n">haml</span> <span class="ss">:replies</span>
    <span class="k">else</span>
      <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/auth/:provider/callback&#39;</span> <span class="k">do</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
    <span class="k">unless</span> <span class="vi">@auth</span> <span class="o">=</span> <span class="no">Authorization</span><span class="o">.</span><span class="n">find_from_hash</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">logged_in?</span>
        <span class="no">Authorization</span><span class="o">.</span><span class="n">create_from_hash</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">uri</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="n">current_user</span><span class="p">)</span>
        <span class="n">redirect</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">/edit&quot;</span>
      <span class="k">else</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:nickname</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:website</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;urls&#39;</span><span class="o">][</span><span class="s1">&#39;Website&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;description&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:image</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;image&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;email&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>let&rsquo;s store their oauth stuff so they don&rsquo;t have to re-login after</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_secret</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;secret&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-We_can_probably_get_rid_of_this_since_the_user_confirmation_will_check_for_duplicate_usernames_[brimil01]'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-We_can_probably_get_rid_of_this_since_the_user_confirmation_will_check_for_duplicate_usernames_[brimil01]">&#182;</a>
        </div>
        <h1>We can probably get rid of this since the user confirmation will check for duplicate usernames [brimil01]</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span> <span class="ow">or</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/profile[.]php[?]id=/</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>we have a username conflict!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Sorry, someone has that name.&quot;</span>
          <span class="n">redirect</span> <span class="s1">&#39;/users/new&#39;</span>
          <span class="k">return</span>
        <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Redirect to confirm page to verify username and provide email</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">redirect</span> <span class="s1">&#39;/users/confirm&#39;</span>
          <span class="k">return</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Lets_store_the_tokens_if_they_don&amp;rsquo;t_alreay_exist'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Lets_store_the_tokens_if_they_don&amp;rsquo;t_alreay_exist">&#182;</a>
        </div>
        <h1>Lets store the tokens if they don&rsquo;t alreay exist</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="vi">@auth</span><span class="o">.</span><span class="n">oauth_token</span><span class="o">.</span><span class="n">nil?</span>
      <span class="vi">@auth</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span>
      <span class="vi">@auth</span><span class="o">.</span><span class="n">oauth_secret</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;secret&#39;</span><span class="o">]</span>
      <span class="vi">@auth</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
      <span class="vi">@auth</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@auth</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>

    <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;re now logged in.&quot;</span>
    <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/auth/failure&#39;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;invalid_credentials&quot;</span>
      <span class="n">haml</span> <span class="ss">:&quot;signup/invalid_credentials&quot;</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">NotFound</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/users/confirm&#39;</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:&quot;users/confirm&quot;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/users/new&#39;</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:&quot;users/new&quot;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/users&#39;</span> <span class="k">do</span>
    <span class="n">set_params_page</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Filter users by search params</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:search</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">params</span><span class="o">[</span><span class="ss">:search</span><span class="o">].</span><span class="n">empty?</span>
      <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:search</span><span class="o">]</span><span class="si">}</span><span class="sr">/i</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Filter users by letter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">elsif</span> <span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">]</span>
      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span>
        <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^[^a-z0-9]/i</span><span class="p">)</span>
      <span class="k">elsif</span>
        <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="n">chr</span><span class="si">}</span><span class="sr">/i</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Sort users alphabetically when filtering by letter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">]</span>
      <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@users</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">:username</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@users</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">:created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>

    <span class="vi">@next_page</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">set_next_prev_page</span>

    <span class="n">haml</span> <span class="ss">:&quot;users/index&quot;</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s1">&#39;/users&#39;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="n">params</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>this is really stupid.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">auth</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:nickname</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;urls&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;urls&#39;</span><span class="o">][</span><span class="s1">&#39;Website&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:website</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;description&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;image&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:image</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;email&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_token</span><span class="o">]</span>
      <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;secret&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_secret</span><span class="o">]</span>

      <span class="no">Authorization</span><span class="o">.</span><span class="n">create_from_hash</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">uri</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="n">user</span><span class="p">)</span>

      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Thanks! You&#39;re all signed up with </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> for your username.&quot;</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
      <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Oops! That username was taken. Pick another?&quot;</span>
      <span class="n">redirect</span> <span class="s1">&#39;/users/new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/logout&quot;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve been logged out.&quot;</span>
    <span class="k">end</span>
    <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>show user profile</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s2">&quot;/users/:slug&quot;</span> <span class="k">do</span>
    <span class="n">set_params_page</span>

    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:slug</span><span class="o">]</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">raise</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">NotFound</span>
    <span class="k">end</span>
    <span class="vi">@author</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">author</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>XXX: the following doesn&rsquo;t work for some reasond
@updates = user.feed.updates.sort{|a, b| b.created_at &lt;=> a.created_at}.paginate(:page => params[:page], :per_page => params[:per_page])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>XXX: this is not webscale</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@updates</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:feed_id</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;descending&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>

    <span class="vi">@next_page</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">set_next_prev_page</span>

    <span class="n">haml</span> <span class="ss">:&quot;users/show&quot;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>subscriber receives updates
should be &lsquo;put&rsquo;, PuSH sucks at REST
post &ldquo;/feeds/:id.atom&rdquo; do
 feed = Feed.first :id => params[:id]
 feed.update_entries(request.body.read, request.url, url(feed.url), request.env[&lsquo;HTTP_X_HUB_SIGNATURE&rsquo;])
end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>unsubscribe from a feed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">delete</span> <span class="s1">&#39;/subscriptions/:id&#39;</span> <span class="k">do</span>
    <span class="n">require_login!</span> <span class="ss">:return</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>

    <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>

    <span class="vi">@author</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span>
    <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="k">if</span> <span class="vi">@author</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>make sure we&rsquo;re following them already</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span> <span class="n">feed</span><span class="o">.</span><span class="n">url</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;re not following </span><span class="si">#{</span><span class="vi">@author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>unfollow them!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span> <span class="n">feed</span>

    <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;No longer following </span><span class="si">#{</span><span class="vi">@author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">&quot;/subscriptions&quot;</span> <span class="k">do</span>
    <span class="n">require_login!</span> <span class="ss">:return</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>

    <span class="n">feed_url</span> <span class="o">=</span> <span class="kp">nil</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Allow for a variety of feed addresses</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">case</span> <span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
    <span class="k">when</span><span class="sr"> /^feed:\/\//</span>
      <span class="n">feed_url</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">][</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
    <span class="k">when</span><span class="sr"> /@/</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>TODO: ensure caching of finger lookup.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">acct</span> <span class="o">=</span> <span class="no">Redfinger</span><span class="o">.</span><span class="n">finger</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">)</span>
      <span class="n">feed_url</span> <span class="o">=</span> <span class="n">acct</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span> <span class="n">l</span><span class="o">[</span><span class="s1">&#39;rel&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;http://schemas.google.com/g/2010#updates-from&#39;</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">feed_url</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>make sure we&rsquo;re not following them already</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span> <span class="n">feed_url</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>which means it exists</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:remote_url</span> <span class="o">=&gt;</span> <span class="n">feed_url</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">feed</span><span class="o">.</span><span class="n">nil?</span> <span class="ow">and</span> <span class="n">feed_url</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">feed_id</span> <span class="o">=</span> <span class="n">feed_url</span><span class="o">[/^</span><span class="p">\</span><span class="o">/</span><span class="n">feeds</span><span class="p">\</span><span class="o">/</span><span class="p">(</span><span class="o">.</span><span class="n">+</span><span class="p">)</span><span class="vg">$/</span><span class="p">,</span><span class="mi">1</span><span class="o">]</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">feed_id</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;re already following </span><span class="si">#{</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>

      <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>follow them!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">f</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span> <span class="n">feed_url</span>
    <span class="k">unless</span> <span class="n">f</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;There was a problem following </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">local?</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>remote feeds require some talking to a hub</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">hub_url</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">hubs</span><span class="o">.</span><span class="n">first</span>

      <span class="nb">sub</span> <span class="o">=</span> <span class="no">OSub</span><span class="o">::</span><span class="no">Subscription</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="s2">&quot;/feeds/</span><span class="si">#{</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.atom&quot;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">secret</span><span class="p">)</span>
      <span class="nb">sub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hub_url</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">verify_token</span><span class="p">)</span>

      <span class="nb">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Now following </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>local feed&hellip; redirect to that user&rsquo;s profile</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Now following </span><span class="si">#{</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>publisher will feed the atom to a hub
subscribers will verify a subscription</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s2">&quot;/feeds/:id.atom&quot;</span> <span class="k">do</span>
    <span class="n">content_type</span> <span class="s2">&quot;application/atom+xml&quot;</span>

    <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="s1">&#39;hub.challenge&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>sub = OSub::Subscription.new(request.url, feed.url, nil, feed.verify_token)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>perform the hub&rsquo;s challenge
respond = sub.perform_challenge(params[&lsquo;hub.challenge&rsquo;])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>verify that the random token is the same as when we
subscribed with the hub initially and that the topic
url matches what we expect
verified = params[&lsquo;hub.topic&rsquo;] == feed.url
if verified and sub.verify_subscription(params[&lsquo;hub.verify_token&rsquo;])
 if development?
   puts &ldquo;Verified&rdquo;
 end
 body respond[:body]
 status respond[:status]
else
 if development?
   puts &ldquo;Verification Failed&rdquo;
 end
if the verification fails, the specification forces us to
return a 404 status</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">status</span> <span class="mi">404</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>TODO: Abide by headers that supply cache information</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">body</span> <span class="n">feed</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">uri</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>user edits own profile</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s2">&quot;/users/:username/edit&quot;</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
    <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
      <span class="n">haml</span> <span class="ss">:&quot;users/edit&quot;</span>
    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>user updates own profile</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">put</span> <span class="s2">&quot;/users/:username&quot;</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
    <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">edit_user_profile</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile saved!&quot;</span>
      <span class="k">else</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile could not be saved!&quot;</span>
      <span class="k">end</span>
      <span class="n">redirect</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>an alias for the route of the feed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s2">&quot;/users/:name/feed&quot;</span> <span class="k">do</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">feed</span>
    <span class="n">redirect</span> <span class="s2">&quot;/feeds/</span><span class="si">#{</span><span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.atom&quot;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>This lets us see who is following.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s1">&#39;/users/:name/following&#39;</span> <span class="k">do</span>
    <span class="n">set_params_page</span>

    <span class="n">feeds</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">following</span>

    <span class="vi">@users</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:id</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>

    <span class="n">set_next_prev_page</span>
    <span class="vi">@next_page</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]*</span><span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">feeds</span><span class="o">.</span><span class="n">count</span>

    <span class="n">haml</span> <span class="ss">:&quot;users/list&quot;</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;Following&quot;</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/users/:name/following.json&#39;</span> <span class="k">do</span>
    <span class="n">set_params_page</span>

    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">following</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">author</span> <span class="p">}</span>
    <span class="n">authors</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/users/:name/followers&#39;</span> <span class="k">do</span>
    <span class="n">set_params_page</span>

    <span class="n">feeds</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followers</span>

    <span class="vi">@users</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:id</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>

    <span class="n">set_next_prev_page</span>
    <span class="vi">@next_page</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]*</span><span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">feeds</span><span class="o">.</span><span class="n">count</span>

    <span class="n">haml</span> <span class="ss">:&quot;users/list&quot;</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;Followers&quot;</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/updates&#39;</span> <span class="k">do</span>
    <span class="vi">@updates</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">next_page</span>
          <span class="vi">@next_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">next_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">previous_page</span>
          <span class="vi">@prev_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">previous_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">haml</span> <span class="ss">:world</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s1">&#39;/updates&#39;</span> <span class="k">do</span>
    <span class="n">do_tweet</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:tweet</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
    <span class="n">do_facebook</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:facebook</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span><span class="p">,</span>
                   <span class="ss">:referral_id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:referral_id</span><span class="o">]</span><span class="p">,</span>
                   <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
                   <span class="ss">:twitter</span> <span class="o">=&gt;</span> <span class="n">do_tweet</span><span class="p">,</span>
                   <span class="ss">:facebook</span> <span class="o">=&gt;</span> <span class="n">do_facebook</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>and entry to user&rsquo;s feed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">updates</span> <span class="o">&lt;&lt;</span> <span class="n">u</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">save</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">save</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>tell hubs there is a new entry</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">ping_hubs</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:text</span><span class="o">].</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">1</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Your status is too short!&quot;</span>
    <span class="k">elsif</span> <span class="n">params</span><span class="o">[</span><span class="ss">:text</span><span class="o">].</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">140</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Your status is too long!&quot;</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Update created.&quot;</span>
    <span class="k">end</span>

    <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s1">&#39;/updates/:id&#39;</span> <span class="k">do</span>
    <span class="vi">@update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
    <span class="vi">@referral</span> <span class="o">=</span> <span class="vi">@update</span><span class="o">.</span><span class="n">referral</span>
    <span class="n">haml</span> <span class="ss">:&quot;updates/show&quot;</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:&#39;updates/layout&#39;</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s1">&#39;/signup&#39;</span> <span class="k">do</span>
    <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="s2">&quot;unconfirmed&quot;</span><span class="p">)</span>
    <span class="n">u</span><span class="o">.</span><span class="n">set_perishable_token</span>

    <span class="k">if</span> <span class="n">development?</span>
      <span class="nb">puts</span> <span class="n">uri</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;confirm/</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">perishable_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="no">Notifier</span><span class="o">.</span><span class="n">send_signup_notification</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">perishable_token</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">haml</span> <span class="ss">:&quot;signup/thanks&quot;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/confirm/:token&quot;</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:perishable_token</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>XXX: Handle user being nil (invalid confirmation)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@username</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^([^@]+?)@/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>

    <span class="vi">@valid_username</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="k">unless</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="vi">@username</span>
      <span class="vi">@valid_username</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="n">haml</span> <span class="ss">:&quot;signup/confirm&quot;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/search&quot;</span> <span class="k">do</span>
    <span class="vi">@updates</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:q</span><span class="o">]</span>
      <span class="vi">@updates</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:q</span><span class="o">]</span><span class="p">,</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="vi">@next_page</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="vi">@prev_page</span> <span class="o">=</span> <span class="kp">nil</span>

    <span class="k">if</span> <span class="o">!</span><span class="vi">@updates</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">next_page</span>
      <span class="vi">@next_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">next_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="o">!</span><span class="vi">@updates</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">previous_page</span>
      <span class="vi">@prev_page</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">#{</span><span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="o">.</span><span class="n">build_query</span> <span class="ss">:page</span> <span class="o">=&gt;</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">previous_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    <span class="n">haml</span> <span class="ss">:search</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">&quot;/confirm&quot;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:perishable_token</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:perishable_token</span><span class="o">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
    <span class="n">user</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;confirmed&quot;</span>
    <span class="n">user</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>propagate the authorship to their feed as well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">author</span>
    <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">save</span>

    <span class="n">user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Thanks for signing up!&quot;</span>
    <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/login&quot;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span>
      <span class="n">haml</span> <span class="ss">:&quot;login&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">&quot;/login&quot;</span> <span class="k">do</span>
    <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">nil?</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>signup</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="n">params</span>
      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Thanks for signing up!&quot;</span>
        <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
      <span class="k">else</span>
        <span class="nb">puts</span> <span class="s2">&quot;not saved&quot;</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;There was a problem... can you pick a different username?&quot;</span>
        <span class="n">redirect</span> <span class="s2">&quot;/login&quot;</span>
      <span class="k">end</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-50'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-50">&#182;</a>
        </div>
        <p>login</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Login successful.&quot;</span>
        <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
      <span class="k">else</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;The username or password you entered was incorrect&quot;</span>
        <span class="n">redirect</span> <span class="s2">&quot;/login&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">delete</span> <span class="s1">&#39;/updates/:id&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="nb">id</span><span class="o">|</span>
    <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>

    <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">author</span>
      <span class="n">update</span><span class="o">.</span><span class="n">destroy</span>

      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Update Baleeted!&quot;</span>
      <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;I&#39;m afraid I can&#39;t let you do that, &quot;</span> <span class="o">+</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
      <span class="n">redirect</span> <span class="n">back</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">not_found</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:&#39;error&#39;</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:code</span> <span class="o">=&gt;</span> <span class="mi">404</span><span class="p">,</span> <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;We couldn&#39;t find the page you&#39;re looking for&quot;</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">error</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:&#39;error&#39;</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:code</span> <span class="o">=&gt;</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;Something went wrong&quot;</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/hashtags/:tag&quot;</span> <span class="k">do</span>
    <span class="vi">@hashtag</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:tag</span><span class="o">]</span>
    <span class="n">set_params_page</span>
    <span class="vi">@updates</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">hashtag_search</span><span class="p">(</span><span class="vi">@hashtag</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">set_next_prev_page</span> <span class="k">if</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">total_entries</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span>
    <span class="vi">@timeline</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="vi">@update_text</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
    <span class="n">haml</span> <span class="ss">:dashboard</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/open_source&quot;</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:opensource</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/follow&quot;</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:external_subscription</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">&quot;/contact&quot;</span> <span class="k">do</span>
    <span class="n">haml</span> <span class="ss">:contact</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
